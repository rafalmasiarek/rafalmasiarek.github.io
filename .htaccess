# Block access to Jekyll config and any backups/variants
<FilesMatch "^_config\.ya?ml(\..*)?$">
  Require all denied
</FilesMatch>

<IfModule mod_rewrite.c>
  RewriteEngine On

  # ---------------------------------------------------------
  # KILL: service worker file -> 410 Gone (no longer available)
  # ---------------------------------------------------------
  RewriteRule ^sw-vinyls\.js$ - [G,L]
  RewriteRule ^sw-vinyls\.js\.br$ - [G,L]

  # ----------------------------
  # Kirby under /projects
  # ----------------------------
  # If request is /projects or /projects/*, let Kirby handle it.
  RewriteRule ^projects(/.*)?$ /projects/index.php [QSA,L]

  # CSS
  RewriteCond %{HTTP:Accept-Encoding} br
  RewriteCond %{REQUEST_FILENAME}.br -s
  RewriteRule ^(.+)\.css$ $1.css.br [QSA,L]

  # JS (skip sw-vinyls.js, because it's gone)
  RewriteCond %{REQUEST_URI} !^/sw-vinyls\.js$
  RewriteCond %{HTTP:Accept-Encoding} br
  RewriteCond %{REQUEST_FILENAME}.br -s
  RewriteRule ^(.+)\.js$ $1.js.br [QSA,L]
</IfModule>

<IfModule mod_headers.c>
  <FilesMatch "\.(css|js)\.br$">
    Header set Content-Encoding br
    Header append Vary Accept-Encoding
  </FilesMatch>

  # ---------------------------------------------------------
  # NO-CACHE for the old service worker file (even if someone caches 410)
  # ---------------------------------------------------------
  <FilesMatch "^sw-vinyls\.js(\.br)?$">
    Header always set Cache-Control "no-store, no-cache, must-revalidate, max-age=0"
    Header always set Pragma "no-cache"
    Header always set Expires "0"
  </FilesMatch>
</IfModule>

# Ensure correct MIME types for the rewritten files
<IfModule mod_mime.c>
  AddType text/css .css.br
  AddType application/javascript .js.br
</IfModule>

ErrorDocument 404 /404.html
