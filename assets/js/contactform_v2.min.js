/*!
 *
 * contactform_v2.min.js
 *
 * Contact Form Frontend Script
 * Copyright (c) 2025 Rafał Masiarek. All rights reserved.
 *
 * This file is proprietary and confidential. Unauthorized copying,
 * distribution, modification, or use of this file, in whole or in part,
 * is strictly prohibited without prior written permission of the author.
 *
 * Licensed for internal use only. No license is granted to copy,
 * sublicense, or redistribute this code.
 */

// Endpoints configuration
const ENDPOINTS = {
  csrfGenerate:   '/api/v1/csrf/generate',
  csrfRegenerate: '/api/v1/csrf/regenerate',
  csrfExpiry:     '/api/v1/csrf/token-expiry',
  formSubmit:     '/api/v2/contactform/send'
};

// Target CSRF container
const CSRF_CONTAINER = 'contactform_main';

document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("contact-form"),t=document.getElementById("contact-form-alert"),n=document.getElementById("contact-form-btn"),o=document.getElementById("csrf_token");let a=document.getElementById("cf_request_id");if(a||(a=document.createElement("input"),a.type="hidden",a.name="cf_request_id",a.id="cf_request_id",e.appendChild(a)),a&&(a.value=Math.random().toString(36).substring(2,10)+Date.now().toString(36)),!e||!t||!n||!o)return;(()=>{const t=document.getElementById("contact-form-messageInput");if(!t)return;const n=parseInt(t.getAttribute("maxlength"),10)||5e3;t.hasAttribute("maxlength")||t.setAttribute("maxlength",String(n));const o=document.createElement("div");o.className="textarea-wrapper",t.parentNode.insertBefore(o,t),o.appendChild(t);const a=document.createElement("span");a.className="char-counter",o.appendChild(a);function r(){const e=n-t.value.length;a.textContent=e,a.classList.toggle("red",e<50)}t.addEventListener("input",r),r()})();const r=document.getElementById("g-recaptcha-sitekey"),c=(null==r?void 0:r.value)||e.dataset.recaptchaSitekey||"";fetch(ENDPOINTS.csrfGenerate,{headers:{"X-CSRF-Container":CSRF_CONTAINER},credentials:"same-origin"}).then(e=>e.json()).then(e=>{"success"===e.status&&e.data?.csrf_token&&(o.value=e.data.csrf_token)}).catch(e=>console.error("CSRF token fetch error:",e));async function s(){try{const e=await fetch(ENDPOINTS.csrfRegenerate,{headers:{"X-CSRF-Container":CSRF_CONTAINER},credentials:"same-origin"}),t=await e.json();"success"===t.status&&t.data?.csrf_token&&(o.value=t.data.csrf_token,console.log("CSRF token regenerated and updated."))}catch(e){console.error("CSRF token regeneration error:",e)}}setInterval(async()=>{try{const e=await fetch(ENDPOINTS.csrfExpiry,{headers:{"X-CSRF-Container":CSRF_CONTAINER},credentials:"same-origin"}),t=await e.json();"success"===t.status&&"number"==typeof t.data?.ttl&&t.data.ttl<30&&await s()}catch(e){console.error("CSRF token expiry check error:",e)}},1e4),e.addEventListener("submit",async r=>{r.preventDefault();try{n.classList.remove("btn-enable-on-input"),n.classList.add("btn-disable-on-input"),n.disabled=!0,n.innerHTML='<i class="fas fa-spinner fa-spin"></i> &nbsp; Sending...';const r=new FormData(e);if(c){await new Promise((e,t)=>{let n=0;const o=setInterval(()=>{window.grecaptcha&&"function"==typeof grecaptcha.ready?(clearInterval(o),e()):(n+=50)>5e3&&(clearInterval(o),t(new Error("grecaptcha not loaded")))},50)}),await new Promise(e=>grecaptcha.ready(e));const t=await grecaptcha.execute(c,{action:"contactform"});r.set("g-recaptcha-response",t)}const s=await fetch(ENDPOINTS.formSubmit,{method:"POST",body:r}),l=await s.json(),d=(null==l?void 0:l.data)?.ref?` (Ref: ${l.data.ref})`:"";t.className="success"===l.status?"alert-green":"alert-red",t.textContent=(l.message||"Unexpected response.")+d,t.style.display="block","success"===l.status&&(e.reset(),a&&(a.value=Math.random().toString(36).substring(2,10)+Date.now().toString(36)))}catch(e){console.error("Contact form error:",e),t.className="alert-red",t.textContent="✖ Unexpected error occurred.",t.style.display="block"}finally{n.classList.remove("btn-disable-on-input"),n.classList.add("btn-enable-on-input"),n.disabled=!1,n.innerHTML='<i class="fas fa-paper-plane"></i> &nbsp; Send Email'}})});
