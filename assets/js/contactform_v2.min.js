/*!
 *
 * contactform_v2.min.js
 *
 * Contact Form Frontend Script
 * Copyright (c) 2025 Rafał Masiarek. All rights reserved.
 *
 * This file is proprietary and confidential. Unauthorized copying,
 * distribution, modification, or use of this file, in whole or in part,
 * is strictly prohibited without prior written permission of the author.
 *
 * Licensed for internal use only. No license is granted to copy,
 * sublicense, or redistribute this code.
 */

// Endpoints configuration
const ENDPOINTS = {
  csrfGenerate: '/api/v1/csrf/generate',
  csrfRegenerate: '/api/v1/csrf/regenerate',
  csrfExpiry: '/api/v1/csrf/token-expiry',
  formSubmit: '/api/v2/contactform/send'
};

// Target CSRF container
const CSRF_CONTAINER = 'contactform_main';

document.addEventListener("DOMContentLoaded", () => { const e = document.getElementById("contact-form"), t = document.getElementById("contact-form-alert"), n = document.getElementById("contact-form-btn"), o = document.getElementById("csrf_token"); if (!e || !t || !n || !o) return; let r = document.getElementById("cf_request_id"); r || (r = document.createElement("input"), r.type = "hidden", r.name = "cf_request_id", r.id = "cf_request_id", e.appendChild(r)), r.value = Math.random().toString(36).substring(2, 10) + Date.now().toString(36), function () { const t = document.getElementById("contact-form-messageInput"); if (!t) return; const n = parseInt(t.getAttribute("maxlength"), 10) || 5e3; t.hasAttribute("maxlength") || t.setAttribute("maxlength", String(n)); const o = document.createElement("div"); o.className = "textarea-wrapper", t.parentNode.insertBefore(o, t), o.appendChild(t); const e = document.createElement("span"); function r() { const o = n - t.value.length; e.textContent = o, e.classList.toggle("red", o < 50) } e.className = "char-counter", o.appendChild(e), t.addEventListener("input", r), r() }(); const c = document.getElementById("g-recaptcha-sitekey"), a = (null == c ? void 0 : c.value) || e.dataset.recaptchaSitekey || ""; function s(e) { return fetch(e, { method: "GET", headers: { "X-CSRF-Container": CSRF_CONTAINER }, credentials: "same-origin" }) } s(ENDPOINTS.csrfGenerate).then(e => e.json()).then(e => { "success" === e.status && e.data?.csrf_token && (o.value = e.data.csrf_token) }).catch(e => console.error("CSRF token fetch error:", e)); async function i() { try { const e = await s(ENDPOINTS.csrfRegenerate), t = await e.json(); "success" === t.status && t.data?.csrf_token && (o.value = t.data.csrf_token, console.log("CSRF token regenerated and updated.")) } catch (e) { console.error("CSRF token regeneration error:", e) } } setInterval(async () => { try { const e = await s(ENDPOINTS.csrfExpiry), t = await e.json(); "success" === t.status && "number" == typeof t.data?.ttl && t.data.ttl < 30 && await i() } catch (e) { console.error("CSRF token expiry check error:", e) } }, 1e4), e.addEventListener("submit", async c => { c.preventDefault(); try { n.classList.remove("btn-enable-on-input"), n.classList.add("btn-disable-on-input"), n.disabled = !0, n.innerHTML = '<i class="fas fa-spinner fa-spin"></i> &nbsp; Sending...'; const c = new FormData(e); if (a) { await new Promise((e, t => { let n = 0; const o = setInterval((() => { window.grecaptcha && "function" == typeof grecaptcha.ready ? (clearInterval(o), e()) : (n += 50) > 5e3 && (clearInterval(o), t(new Error("grecaptcha not loaded"))) }), 50) })), await new Promise((e => grecaptcha.ready(e))); const e = await grecaptcha.execute(a, { action: "contactform" }); c.set("g-recaptcha-response", e) } const s = await fetch(ENDPOINTS.formSubmit, { method: "POST", body: c }), i = await s.json(), l = i?.data?.ref ? ` (Ref: ${i.data.ref})` : ""; t.className = "alert " + ("success" === i.status ? "alert-green" : "alert-red"), t.textContent = (i.message || "Unexpected response.") + l, t.style.display = "block", "success" === i.status && (e.reset(), r && (r.value = Math.random().toString(36).substring(2, 10) + Date.now().toString(36))) } catch (e) { console.error("Contact form error:", e), t.className = "alert alert-red", t.textContent = "✖ Unexpected error occurred.", t.style.display = "block" } finally { n.classList.remove("btn-disable-on-input"), n.classList.add("btn-enable-on-input"), n.disabled = !1, n.innerHTML = '<i class="fas fa-paper-plane"></i> &nbsp; Send Email' } }) });