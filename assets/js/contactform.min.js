document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("contact-form"),t=document.getElementById("contact-form-alert"),n=document.getElementById("contact-form-btn"),o=document.getElementById("csrf_token");let a=document.getElementById("cf_request_id");a||(a=document.createElement("input"),a.type="hidden",a.name="cf_request_id",a.id="cf_request_id",e.appendChild(a)),a.value=Math.random().toString(36).substring(2,10)+Date.now().toString(36);if(!e||!t||!n||!o)return;(()=>{const t=document.getElementById("contact-form-messageInput");if(!t)return;const n=parseInt(t.getAttribute("maxlength"),10)||5e3;t.hasAttribute("maxlength")||t.setAttribute("maxlength",String(n));const o=document.createElement("div");o.className="textarea-wrapper",t.parentNode.insertBefore(o,t),o.appendChild(t);const a=document.createElement("span");a.className="char-counter",o.appendChild(a);function r(){const e=n-t.value.length;a.textContent=e,a.classList.toggle("red",e<50)}t.addEventListener("input",r),r()})();const r=document.getElementById("g-recaptcha-sitekey"),c=r?.value||e.dataset.recaptchaSitekey||"";fetch("/api/csrf/generate").then(e=>e.json()).then(e=>{"success"===e.status&&e.data.csrf_token&&(o.value=e.data.csrf_token)}).catch(e=>console.error("CSRF token fetch error:",e));async function s(){try{const e=await fetch("/api/csrf/regenerate"),t=await e.json();"success"===t.status&&t.data.csrf_token&&(o.value=t.data.csrf_token,console.log("CSRF token regenerated and updated."))}catch(e){console.error("CSRF token regeneration error:",e)}}setInterval(async()=>{try{const e=await fetch("/api/csrf/token-expiry"),t=await e.json();"success"===t.status&&"number"==typeof t.data.ttl&&t.data.ttl<30&&await s()}catch(e){console.error("CSRF token expiry check error:",e)}},1e4),e.addEventListener("submit",async r=>{r.preventDefault();try{n.classList.remove("btn-enable-on-input"),n.classList.add("btn-disable-on-input"),n.disabled=!0,n.innerHTML='<i class="fas fa-spinner fa-spin"></i> &nbsp; Sending...';const r=new FormData(e);if(c){await(async(e=5e3)=>{const t=Date.now();for(;(window.grecaptcha&&"function"==typeof grecaptcha.ready)===!1;){if(Date.now()-t>e)throw new Error("grecaptcha not loaded");await new Promise(e=>setTimeout(e,50))}})(),await new Promise(e=>grecaptcha.ready(e));const t=await grecaptcha.execute(c,{action:"contactform"});r.set("g-recaptcha-response",t)}const s=await fetch("/api/contactform/send",{method:"POST",body:r}),l=await s.json(),d=l?.data?.ref?` (Ref: ${l.data.ref})`:"";t.classList.remove("alert-green","alert-red"),t.textContent=(l.message||"Unexpected response.")+d,t.classList.add("success"===l.status?"alert-green":"alert-red"),t.style.display="block","success"===l.status&&(e.reset(),a.value=Math.random().toString(36).substring(2,10)+Date.now().toString(36))}catch(e){console.error("Contact form error:",e),t.classList.remove("alert-green"),t.classList.add("alert-red"),t.textContent="‚ùå Unexpected error occurred.",t.style.display="block"}finally{n.classList.remove("btn-disable-on-input"),n.classList.add("btn-enable-on-input"),n.disabled=!1,n.innerHTML='<i class="fas fa-paper-plane"></i> &nbsp; Send Email'}})});
